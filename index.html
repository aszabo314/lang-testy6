<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Czech Vocabulary Trainer</title>
    <link rel="stylesheet" href="styles.css">
    <script src="vocabulary.js"></script>
</head>
<body>
    <div class="container">
        <!-- Header with Stats -->
        <div class="header">
            <h1>üá®üáø Czech Vocabulary Trainer üá©üá™</h1>
            <div class="stats-panel">
                <div class="stat-item">
                    <span>üî• Streak:</span>
                    <span class="stat-highlight" id="streak">0</span>
                </div>
                <div class="stat-item">
                    <span>‚≠ê Score:</span>
                    <span class="stat-highlight" id="score">0</span>
                </div>
                <div class="stat-item next-worth" id="nextWorth">
                    Next: 10 pts
                </div>
                <div class="stat-item">
                    <span>‚úì</span>
                    <span id="correct">0</span>
                    <span>‚ö†Ô∏è</span>
                    <span id="almost">0</span>
                    <span>‚ùå</span>
                    <span id="wrong">0</span>
                </div>
            </div>
        </div>

        <!-- Main Card -->
        <div class="card-container" id="cardContainer">
            <div class="emoji-card" id="emojiCard">
                <div class="emoji-card-content">
                    <div class="emoji-grid" id="emojiGrid">
                        <!-- Emojis will be inserted here -->
                    </div>
                    <div class="german-word" id="germanWord">
                        <!-- German word will be inserted here -->
                    </div>
                </div>
            </div>

            <div class="input-section">
                <label class="input-label" for="answerInput">Czech translation:</label>
                <input 
                    type="text" 
                    id="answerInput" 
                    class="answer-input" 
                    placeholder="Type the Czech translation..."
                    autocomplete="off"
                    autofocus
                >
                <button class="submit-btn" id="submitBtn">Submit Answer</button>
                <div class="feedback" id="feedback"></div>
                <button class="next-btn" id="nextBtn">Next Word ‚Üí</button>
            </div>
        </div>

        <!-- Most Missed Panel -->
        <div class="mistakes-panel">
            <h3>‚ö†Ô∏è Most Missed (Higher chance to appear):</h3>
            <div id="mistakesList">
                <div style="color: #999; font-style: italic;">No mistakes yet - keep going!</div>
            </div>
        </div>
    </div>

    <script>

        // ============================================================
        // GAME STATE
        // ============================================================
        let gameState = {
            currentEntry: null,
            streak: 0,
            score: 0,
            correctCount: 0,
            almostCount: 0,
            wrongCount: 0,
            sessionStats: {}, // { entryId: { attempts, correct, wrong, lastSeen, errorRate } }
            answeredThisRound: false
        };

        // ============================================================
        // HELPER FUNCTIONS
        // ============================================================

        // Calculate exponential streak multiplier
        function calculateStreakMultiplier(streak) {
            return 1.0 + Math.pow(streak * 0.15, 1.3);
        }

        // Calculate points for next answer
        function calculateNextPoints(streak) {
            const basePoints = 10;
            const multiplier = calculateStreakMultiplier(streak);
            return Math.round(basePoints * multiplier);
        }

        // Levenshtein distance for fuzzy matching
        function levenshteinDistance(str1, str2) {
            const matrix = [];
            for (let i = 0; i <= str2.length; i++) {
                matrix[i] = [i];
            }
            for (let j = 0; j <= str1.length; j++) {
                matrix[0][j] = j;
            }
            for (let i = 1; i <= str2.length; i++) {
                for (let j = 1; j <= str1.length; j++) {
                    if (str2.charAt(i - 1) === str1.charAt(j - 1)) {
                        matrix[i][j] = matrix[i - 1][j - 1];
                    } else {
                        matrix[i][j] = Math.min(
                            matrix[i - 1][j - 1] + 1,
                            matrix[i][j - 1] + 1,
                            matrix[i - 1][j] + 1
                        );
                    }
                }
            }
            return matrix[str2.length][str1.length];
        }

        // Remove diacritics
        function removeDiacritics(str) {
            return str.normalize('NFD').replace(/[\u0300-\u036f]/g, '');
        }

        // Normalize string for comparison
        function normalizeString(str) {
            return str.toLowerCase()
                .trim()
                .replace(/[.,!?;:]/g, '')
                .replace(/\s+/g, ' ');
        }

        // Compare answers with fuzzy matching
        function compareAnswers(userInput, correctAnswer) {
            const userNorm = normalizeString(userInput);
            const correctNorm = normalizeString(correctAnswer);

            // Exact match
            if (userNorm === correctNorm) return 'PERFECT';

            // Levenshtein distance check
            const distance = levenshteinDistance(userNorm, correctNorm);
            if (distance <= 2 && distance <= correctNorm.length * 0.2) {
                return 'ALMOST';
            }

            // Check without diacritics
            if (removeDiacritics(userNorm) === removeDiacritics(correctNorm)) {
                return 'ALMOST';
            }

            return 'WRONG';
        }

        // Weighted random selection
        function selectNextWord() {
            const weights = vocabularyDatabase.map(entry => {
                const stats = gameState.sessionStats[entry.id] || { 
                    attempts: 0, 
                    errorRate: 0, 
                    lastSeen: 0 
                };

                let weight = 1.0;

                // Boost by error rate (0-10x multiplier)
                weight *= (1 + stats.errorRate * 9);

                // Reduce if seen recently (within last 5 words)
                const timeSinceLastSeen = Date.now() - stats.lastSeen;
                if (timeSinceLastSeen < 30000) weight *= 0.1; // 30 seconds

                // Boost if never seen
                if (stats.attempts === 0) weight *= 2;

                return weight;
            });

            // Weighted random selection
            const totalWeight = weights.reduce((sum, w) => sum + w, 0);
            let random = Math.random() * totalWeight;

            for (let i = 0; i < vocabularyDatabase.length; i++) {
                random -= weights[i];
                if (random <= 0) {
                    return vocabularyDatabase[i];
                }
            }

            return vocabularyDatabase[0];
        }

        // ============================================================
        // UI FUNCTIONS
        // ============================================================

        function renderCard(entry) {
            // Set gradient background
            const card = document.getElementById('emojiCard');
            card.style.background = `linear-gradient(135deg, ${entry.categoryColor} 0%, ${entry.uniqueColor} 100%)`;

            // Render emoji grid
            const emojiGrid = document.getElementById('emojiGrid');
            emojiGrid.innerHTML = '';
            entry.emojiGrid.forEach(emoji => {
                const cell = document.createElement('div');
                cell.className = 'emoji-cell';
                cell.textContent = emoji;
                emojiGrid.appendChild(cell);
            });

            // Set German word
            document.getElementById('germanWord').textContent = entry.german;

            // Clear input
            document.getElementById('answerInput').value = '';
            document.getElementById('answerInput').focus();

            // Hide feedback and next button
            document.getElementById('feedback').style.display = 'none';
            document.getElementById('nextBtn').style.display = 'none';
            document.getElementById('submitBtn').style.display = 'block';

            gameState.answeredThisRound = false;
        }

        function updateStats() {
            document.getElementById('streak').textContent = gameState.streak;
            document.getElementById('score').textContent = gameState.score.toLocaleString();
            document.getElementById('correct').textContent = gameState.correctCount;
            document.getElementById('almost').textContent = gameState.almostCount;
            document.getElementById('wrong').textContent = gameState.wrongCount;

            const nextPoints = calculateNextPoints(gameState.streak);
            document.getElementById('nextWorth').textContent = `Next: ${nextPoints} pts`;
        }

        function showFeedback(result, correctAnswer) {
            const feedback = document.getElementById('feedback');
            feedback.style.display = 'block';

            if (result === 'PERFECT') {
                feedback.className = 'feedback correct';
                feedback.textContent = '‚úÖ Perfect! ' + correctAnswer;
                document.getElementById('cardContainer').classList.add('flash-correct');
                setTimeout(() => {
                    document.getElementById('cardContainer').classList.remove('flash-correct');
                }, 600);
            } else if (result === 'ALMOST') {
                feedback.className = 'feedback almost';
                feedback.textContent = '‚ö†Ô∏è Almost right! Correct: ' + correctAnswer;
            } else {
                feedback.className = 'feedback wrong';
                feedback.textContent = '‚ùå Wrong! Correct answer: ' + correctAnswer;
                document.getElementById('cardContainer').classList.add('shake', 'flash-wrong');
                setTimeout(() => {
                    document.getElementById('cardContainer').classList.remove('shake', 'flash-wrong');
                }, 600);
            }

            document.getElementById('submitBtn').style.display = 'none';
            document.getElementById('nextBtn').style.display = 'block';
            document.getElementById('nextBtn').focus();
        }

        function updateMistakesList() {
            const mistakesList = document.getElementById('mistakesList');
            
            // Calculate top mistakes
            const mistakes = Object.entries(gameState.sessionStats)
                .filter(([id, stats]) => stats.wrong > 0)
                .map(([id, stats]) => {
                    const entry = vocabularyDatabase.find(e => e.id === id);
                    return {
                        entry: entry,
                        errors: stats.wrong,
                        errorRate: stats.errorRate
                    };
                })
                .sort((a, b) => b.errors - a.errors)
                .slice(0, 10);

            if (mistakes.length === 0) {
                mistakesList.innerHTML = '<div style="color: #999; font-style: italic;">No mistakes yet - keep going!</div>';
                return;
            }

            mistakesList.innerHTML = mistakes.map((mistake, index) => {
                const emoji = mistake.entry.emojiGrid[4]; // Center emoji
                return `
                    <div class="mistake-item">
                        <span class="emoji-preview">${emoji}</span>
                        ${index + 1}. ${mistake.entry.german} ‚Üí ${mistake.entry.czech} 
                        (${mistake.errors} ${mistake.errors === 1 ? 'error' : 'errors'})
                    </div>
                `;
            }).join('');
        }

        // ============================================================
        // GAME LOGIC
        // ============================================================

        function checkAnswer() {
            if (gameState.answeredThisRound) return;

            const userInput = document.getElementById('answerInput').value;
            if (!userInput.trim()) return;

            gameState.answeredThisRound = true;

            const result = compareAnswers(userInput, gameState.currentEntry.czech);
            
            // Update stats for this entry
            if (!gameState.sessionStats[gameState.currentEntry.id]) {
                gameState.sessionStats[gameState.currentEntry.id] = {
                    attempts: 0,
                    correct: 0,
                    wrong: 0,
                    lastSeen: Date.now(),
                    errorRate: 0
                };
            }

            const stats = gameState.sessionStats[gameState.currentEntry.id];
            stats.attempts++;
            stats.lastSeen = Date.now();

            if (result === 'PERFECT') {
                const points = calculateNextPoints(gameState.streak);
                gameState.score += points;
                gameState.streak++;
                gameState.correctCount++;
                stats.correct++;
            } else if (result === 'ALMOST') {
                const points = Math.round(calculateNextPoints(gameState.streak) / 2);
                gameState.score += points;
                gameState.streak++; // Streak continues for "almost"
                gameState.almostCount++;
                stats.correct++; // Count as correct for error rate
            } else {
                gameState.streak = 0; // Reset streak
                gameState.wrongCount++;
                stats.wrong++;
            }

            // Update error rate
            stats.errorRate = stats.wrong / stats.attempts;

            updateStats();
            showFeedback(result, gameState.currentEntry.czech);
            updateMistakesList();
        }

        function nextWord() {
            gameState.currentEntry = selectNextWord();
            renderCard(gameState.currentEntry);
            updateStats();
        }

        // ============================================================
        // EVENT LISTENERS
        // ============================================================

        document.getElementById('submitBtn').addEventListener('click', checkAnswer);
        document.getElementById('nextBtn').addEventListener('click', nextWord);

        document.getElementById('answerInput').addEventListener('keypress', (e) => {
            if (e.key === 'Enter' && !gameState.answeredThisRound) {
                checkAnswer();
            } else if (e.key === 'Enter' && gameState.answeredThisRound) {
                nextWord();
            }
        });

        // ============================================================
        // INITIALIZE GAME
        // ============================================================

        function initGame() {
            console.log('Loaded vocabulary entries:', vocabularyDatabase.length);
            nextWord();
        }

        // Start the game when page loads
        initGame();
    </script>
</body>
</html>
